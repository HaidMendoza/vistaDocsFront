<div class="plantas-container">
  <!-- Secci√≥n superior que NO se elimina -->
  <div class="right-section">
    <h2 class="title">Plantas</h2>
    <div class="search-container">
      <svg
        class="search-icon"
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
      <input
        type="text"
        placeholder="Buscar plantas o unidades"
        class="search-input"
      />
    </div>

    <div class="header-icons">
      <button class="icon-btn settings-btn">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          fill="none"
          viewBox="0 0 24 24"
          stroke-width="1.5"
          stroke="currentColor"
          class="size-6"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M10.343 3.94c.09-.542.56-.94 1.11-.94h1.093c.55 0 1.02.398 1.11.94l.149.894c.07.424.384.764.78.93.398.164.855.142 1.205-.108l.737-.527a1.125 1.125 0 0 1 1.45.12l.773.774c.39.389.44 1.002.12 1.45l-.527.737c-.25.35-.272.806-.107 1.204.165.397.505.71.93.78l.893.15c.543.09.94.559.94 1.109v1.094c0 .55-.397 1.02-.94 1.11l-.894.149c-.424.07-.764.383-.929.78-.165.398-.143.854.107 1.204l.527.738c.32.447.269 1.06-.12 1.45l-.774.773a1.125 1.125 0 0 1-1.449.12l-.738-.527c-.35-.25-.806-.272-1.203-.107-.398.165-.71.505-.781.929l-.149.894c-.09.542-.56.94-1.11.94h-1.094c-.55 0-1.019-.398-1.11-.94l-.148-.894c-.071-.424-.384-.764-.781-.93-.398-.164-.854-.142-1.204.108l-.738.527c-.447.32-1.06.269-1.45-.12l-.773-.774a1.125 1.125 0 0 1-.12-1.45l.527-.737c.25-.35.272-.806.108-1.204-.165-.397-.506-.71-.93-.78l-.894-.15c-.542-.09-.94-.56-.94-1.109v-1.094c0-.55.398-1.02.94-1.11l.894-.149c.424-.07.765-.383.93-.78.165-.398.143-.854-.108-1.204l-.526-.738a1.125 1.125 0 0 1 .12-1.45l.773-.773a1.125 1.125 0 0 1 1.45-.12l.737.527c.35.25.807.272 1.204.107.397-.165.71-.505.78-.929l.15-.894Z"
          />
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"
          />
        </svg>
      </button>

      <button class="icon-btn notification-btn">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
        </svg>
        <span class="notification-badge"></span>
      </button>

      <div class="profile-container">
        <img src="" alt="Profile" class="profile-image" />
      </div>
    </div>
  </div>

  <!-- Subt√≠tulo -->
  <p class="subtitle">
    Gestiona las plantas de tu proyecto de manera eficiente.
  </p>

  <!-- Botones de navegaci√≥n de plantas (si aplica) -->
  <div class="buttons-container">
    <button class="btn planta-inferior">Planta Inferior</button>
    <button class="btn planta-superior">Planta Superior</button>
  </div>

  <!-- SECCI√ìN DE SUBIDA DE PLANTAS (se oculta si ya hay unidades detectadas) -->
  <div
    class="upload-section"
    *ngIf="!plantaActual?.units || plantaActual?.units?.length === 0"
  >
    <h3 class="section-title">Subir Nueva Planta</h3>

    <!-- Formulario -->
    <form
      [formGroup]="plantaForm"
      (ngSubmit)="crearPlanta()"
      class="compact-upload-form"
    >
      <!-- Campos -->
      <div class="compact-fields">
        <div class="field-inline">
          <label class="field-label">Nombre de la Planta</label>
          <input
            type="text"
            formControlName="name"
            class="compact-input"
            placeholder="Ej: Planta Baja, Primer Piso..."
            [class.error]="
              plantaForm.get('name')?.invalid && plantaForm.get('name')?.touched
            "
          />
        </div>

        <div class="field-inline">
          <label class="field-label">Nivel</label>
          <input
            type="number"
            formControlName="level"
            class="compact-input level-input"
            min="0"
            [class.error]="
              plantaForm.get('level')?.invalid &&
              plantaForm.get('level')?.touched
            "
          />
        </div>
      </div>

      <!-- √Årea drag & drop -->
      <div
        class="main-upload-area"
        (dragover)="onDragOver($event)"
        (drop)="onDrop($event)"
        (dragleave)="onDragLeave($event)"
      >
        <div
          *ngIf="!imagenPrevisualizada"
          class="drop-zone"
          [class.drag-over]="dragOver"
        >
          <div class="upload-icon">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="80"
              height="80"
              fill="#4F46E5"
              viewBox="0 0 24 24"
            >
              <path d="M2 22h20M4 22V10h4v12M10 22V4h8v18M2 10h20M14 4V2h4v2" />
            </svg>
          </div>
          <h4 class="drop-title">Sube el plano de la planta</h4>
          <p class="drop-description">
            Arrastra y suelta el archivo aqu√≠ o haz clic para seleccionar.
          </p>
          <p class="format-info">Formatos aceptados: PNG, JPG, PDF</p>

          <input
            type="file"
            id="fileInput"
            (change)="onFileSelected($event)"
            accept="image/*,.pdf"
            hidden
          />
          <label for="fileInput" class="upload-button">
            <span *ngIf="!isUploading">Seleccionar Archivo ‚¨Ü</span>
            <span *ngIf="isUploading">Subiendo... ‚è≥</span>
          </label>
        </div>

        <!-- Vista previa -->
        <div *ngIf="imagenPrevisualizada" class="preview-section">
          <img
            [src]="imagenPrevisualizada"
            alt="Plano"
            class="main-preview-image"
          />
          <div class="preview-buttons">
            <button
              type="button"
              class="cancel-button"
              (click)="cancelarSubida()"
              [disabled]="isUploading"
            >
              Cancelar
            </button>
            <button
              type="submit"
              class="save-button"
              [disabled]="isUploading || plantaForm.invalid"
            >
              <span *ngIf="!isUploading">Guardar Planta</span>
              <span *ngIf="isUploading">Guardando...</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Errores -->
      <div
        class="form-errors"
        *ngIf="
          plantaForm.get('name')?.invalid && plantaForm.get('name')?.touched
        "
      >
        <small class="error-text">El nombre es requerido</small>
      </div>
      <div
        class="form-errors"
        *ngIf="
          plantaForm.get('level')?.invalid && plantaForm.get('level')?.touched
        "
      >
        <small class="error-text">El nivel debe ser mayor a 0</small>
      </div>
    </form>
  </div>

  <!-- VISUALIZACI√ìN DE LA PLANTA -->
  <div class="planta-visualizer" *ngIf="plantaActual">
    <div class="visualizer-header">
      <h3 class="section-title">{{ plantaActual.name }}</h3>
      <div class="visualizer-actions">
        <button
          class="action-btn detect-btn"
          (click)="detectarUnidadesEnPlano()"
          [disabled]="isDetecting"
        >
          <span *ngIf="!isDetecting">üîç Detectar Unidades</span>
          <span *ngIf="isDetecting">Detectando... ‚è≥</span>
        </button>
        <button class="action-btn clear-btn" (click)="limpiarPlanta()">
          üóëÔ∏è Limpiar
        </button>
      </div>
    </div>

    <!-- Imagen + Unidades -->
    <div class="planta-image-container">
      <svg
        [attr.width]="imageWidth"
        [attr.height]="imageHeight"
        class="planta-svg"
      >
        <image
          [attr.href]="plantaActual.floorPlanUrl"
          x="0"
          y="0"
          [attr.width]="imageWidth"
          [attr.height]="imageHeight"
        ></image>

        <!-- Pol√≠gonos interactivos -->
        <polygon
          *ngFor="let unit of plantaActual.units; let i = index"
          [attr.points]="getPoints(unit.polygon)"
          fill="rgba(255, 0, 0, 0.2)"
          stroke="#ff0000"
          stroke-width="2"
          class="unit-polygon"
          (click)="abrirModalUnidad(unit.id)"
        ></polygon>

        <!-- N√∫meros -->
        <text
          *ngFor="let unit of plantaActual.units; let i = index"
          [attr.x]="unit.centerX"
          [attr.y]="unit.centerY"
          fill="#ffffff"
          font-size="14"
          font-weight="bold"
          text-anchor="middle"
          class="unit-number"
        >
          {{ unit.number || i + 1 }}
        </text>
      </svg>
    </div>

    <!-- Info -->
    <div
      class="units-info"
      *ngIf="plantaActual.units && plantaActual.units.length > 0"
    >
      <p class="units-count">
        <strong>{{ plantaActual.units.length }} unidades detectadas</strong>
      </p>
    </div>
  </div>

  <!-- Estado vac√≠o -->
  <div class="empty-state" *ngIf="!plantaActual">
    <div class="empty-icon">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="80"
        height="80"
        fill="none"
        stroke="#9CA3AF"
        stroke-width="1.5"
        viewBox="0 0 24 24"
      >
        <path d="M2 22h20M4 22V10h4v12M10 22V4h8v18M2 10h20M14 4V2h4v2" />
      </svg>
    </div>
    <h3>No hay planta cargada</h3>
    <p>Sube una planta para comenzar a trabajar</p>
  </div>

  <div
    class="modal"
    *ngIf="modalAbierto"
    (click)="onModalBackdropClick($event)"
    (keydown)="onKeyDown($event)"
    tabindex="-1"
  >
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalles de la Unidad</h3>
        <button
          class="close-btn"
          (click)="cerrarModal()"
          aria-label="Cerrar modal"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      <div class="modal-body" *ngIf="obtenerUnidadCompleta() as unidad">
        <div class="content-modal-unit">
          <form [formGroup]="unitForm" (ngSubmit)="onSubmitUnit()">
            <section class="form-group">
              <label for="number">Numeraci√≥n</label>
              <input
                id="number"
                type="text"
                formControlName="number"
                [readonly]="modoConsulta"
              />
              <div
                *ngIf="
                  unitForm.get('number')?.invalid &&
                  unitForm.get('number')?.touched
                "
                class="error-message"
              >
                El campo es obligatorio.
              </div>
            </section>

            <section class="upload-box" *ngIf="!modoConsulta">
              <input
                id="documentName"
                type="file"
                (change)="fileUnit($event)"
                accept="application/pdf"
                multiple
                [disabled]="modoConsulta"
              />
            </section>

            <section *ngIf="modoConsulta" class="documentacion">
              <h4 class="titulo">Documentaci√≥n</h4>

              <div *ngIf="documentos.length > 0; else noDocs">
                <div class="doc-card" *ngFor="let doc of documentos">
                  <span class="icono">üìÑ</span>
                  <a [href]="doc.url" target="_blank">{{ doc.name }}</a>
                </div>
              </div>

              <ng-template #noDocs>
                <div class="doc-empty">
                  <span class="icono">üìã</span>
                  <p>No se han asignado documentos a esta unidad</p>
                </div>
              </ng-template>
            </section>
          </form>
        </div>
      </div>

      <div class="modal-body" *ngIf="!obtenerUnidadCompleta()">
        <p>No se pudo cargar la informaci√≥n de la unidad.</p>
      </div>

      <div class="modal-footer">
        <button class="btn secondary" (click)="cerrarModal()">Cerrar</button>
        <button
          *ngIf="modoConsulta"
          class="btn primary"
          (click)="activarEdicion()"
        >
          Editar Unidad
        </button>

        <button
          *ngIf="!modoConsulta"
          type="submit"
          (click)="onSubmitUnit()"
          class="btn primary"
        >
          Guardar Cambios
        </button>
      </div>
    </div>
  </div>
</div>
